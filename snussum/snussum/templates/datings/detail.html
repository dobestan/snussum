{% extends "_base.html" %}
{% load datings %}

{% block content %}
  {% with partner=dating|partner:user partner_is_accepted=dating|partner_is_accepted:user myself_is_accepted=dating|myself_is_accepted:user %}
    <div class="container">
      <div class="col-xs-12 col-sm-8">
        <section id="profile">
        </section>

        <section id="introduce">
          <div class="panel panel-default">
            <div class="panel-body">
              <h2>자기소개</h2>
              {{ partner.userprofile.profile_introduce|safe }}
            </div>
          </div>
        </section>

        <section id="analytics">
          <div class="panel panel-default">
            <div class="panel-body">
              <h2>통계</h2>
            </div>
          </div>
        </section>

        <section id="dating-accept-section" class="visible-xs">
          <div class="panel panel-default border border-red">
            <div class="panel-body">
              <h2>수락하기</h2>
              {% include "datings/_accept_form.html" %}
            </div>
          </div>
        </section>

        <section id="comments" data-hash-id="{{ dating.hash_id }}">
          <div class="kakaotalk">
            {% for comment in dating.comment_set.all %}
              {% if comment.user == user %}
                {% include "datings/_comments/_me.html" with content=comment.content %} 
              {% else %}
                {% include "datings/_comments/_partner.html" with content=comment.content %} 
              {% endif %}
            {% endfor %}
          </div>

          <section id="comments-input">
            <div class="row">
              <div class="col-xs-10 col-no-padding">
                <textarea name="" id="" rows="4" class="form-control"></textarea>
              </div>
              <div class="col-xs-2 col-no-padding">
                <button>전송</button>
              </div>
            </div>
          </section>
        </section>
      </div>

      <div class="col-xs-12 col-sm-4">
        <section id="dating-accept-sidebar" data-spy="affix">
          <div class="panel panel-default border border-red">
            <div class="panel-body">
              <h2>수락하기</h2>
              {% include "datings/_accept_form.html" %}
            </div>
          </div>
        </section>
      </div>

      <section class="visible-xs">
        <a id="btn-dating-accept" href="#dating-accept-section" class="text-center btn-snussum-red">
          <i class="fa fa-sign-in"></i>&nbsp;수락하기
        </a>
      </section>

    </div>


<script type="text/javascript" charset="utf-8">
$(document).ready(function(){
    var comments = $("section#comments");
    var dating_hash_id = $(comments).data("hash-id");

    $("section#comments button").click(function(){
      var content = $(comments).find("textarea").val();
      var data = {
        'content': content
      };
      
      function kakaotalk(content){
        var html = '<div class="row">\
          <div class="comment comment-by-me col-xs-9 col-xs-offset-3">\
            <div class="media">\
              <div class="media-body">\
                <p>\
                CONTENT\
                </p>\
              </div>\
            </div>\
          </div>\
        </div>'.replace('CONTENT', content);

        $(comments).find("div.kakaotalk").append(html);
        $(comments).find("textarea").val("");
      };
      
      $.ajax({
        url: '/api/ssum/' + dating_hash_id + '/comment/',
        type: 'POST',
        data: data,
        success: function(result){
          kakaotalk(result.content);
        },
        error: function(result){
        }
      });
    });
});
</script>

  {% endwith %}
{% endblock %}
